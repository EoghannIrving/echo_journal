{% extends "base.html" %}

{% block title %}Settings - Echo Journal{% endblock %}

{% block main_classes %}w-full max-w-md md:max-w-2xl lg:max-w-5xl xl:max-w-6xl mx-auto space-y-6 bg-gray-100 dark:bg-[#222] text-gray-800 dark:text-gray-100{% endblock %}

{% block header_title %}
  <h1 id="welcome-message" class="font-serif font-bold text-[clamp(1.75rem,2vw+1rem,2.5rem)] text-center mb-2 opacity-0">Settings</h1>
{% endblock %}

{% block content %}

<section class="w-full max-w-md mx-auto space-y-4 bg-gray-100 dark:bg-[#222] text-gray-800 dark:text-gray-100 p-4 rounded-xl paper-card">
  <form id="settings-form" class="w-full text-sm space-y-4">
    <p class="text-center text-gray-500 dark:text-gray-400">Enable or disable optional integrations and edit server settings. Values are saved to <code>settings.yaml</code>. Changes require a restart.</p>
    <fieldset id="integration-settings" class="space-y-2 text-left">
      <legend class="sr-only">Integrations</legend>
      <label class="flex items-center gap-2 justify-start"><input type="checkbox" id="integration-wordnik" class="mr-2 accent-blue-600 dark:accent-blue-400">Wordnik word of the day</label>
      <label class="flex items-center gap-2 justify-start"><input type="checkbox" id="integration-immich" class="mr-2 accent-blue-600 dark:accent-blue-400">Immich photos</label>
      <label class="flex items-center gap-2 justify-start"><input type="checkbox" id="integration-jellyfin" class="mr-2 accent-blue-600 dark:accent-blue-400">Jellyfin media</label>
      <label class="flex items-center gap-2 justify-start"><input type="checkbox" id="integration-fact" class="mr-2 accent-blue-600 dark:accent-blue-400">Fact of the day</label>
    </fieldset>
    <div id="settings-fields" class="space-y-2"></div>
    <button type="button" id="save-settings" class="mx-auto block bg-blue-600 hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 text-white px-4 py-2 rounded font-semibold transition focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400">Save</button>
  </form>
</section>

<footer class="w-full max-w-md mt-8 bg-gray-100 dark:bg-[#222] text-[clamp(0.9rem,0.8vw+0.8rem,1rem)] text-gray-500 dark:text-gray-400 text-center leading-snug tracking-wide">
  <img src="/static/icons/echo_journal_transparent_128x128.png" alt="Echo Journal logo" class="h-16 inline align-middle opacity-50 transition">
  Echo Journal
</footer>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const animateText = (target, startDelay = 0, letterDelay = 80, wordDelay = 150) => {
    if (!target) return 0;
    const text = target.textContent.trim();
    target.textContent = "";

    let delay = startDelay;
    const tokens = text.split(/(\s+)/);

    tokens.forEach((token) => {
      if (/^\s+$/.test(token)) {
        target.appendChild(document.createTextNode(token));
        return;
      }

      const wordSpan = document.createElement('span');
      wordSpan.style.whiteSpace = 'nowrap';
      wordSpan.style.display = 'inline-block';

      Array.from(token).forEach((ch) => {
        const letter = document.createElement('span');
        letter.textContent = ch;
        letter.className = 'letter-span inline-block opacity-0 transition-opacity duration-200';
        letter.style.transitionDelay = `${delay}ms`;
        delay += letterDelay;
        wordSpan.appendChild(letter);
      });

      delay += wordDelay;
      target.appendChild(wordSpan);
    });

    target.classList.remove('opacity-0');
    requestAnimationFrame(() => {
      target.querySelectorAll('.letter-span').forEach((span) => span.classList.add('opacity-100'));
    });

    return delay;
  };

  const welcomeEl = document.getElementById("welcome-message");
  if (welcomeEl) {
    animateText(welcomeEl, 0, 60, 200);
  }

  const settingsForm = document.getElementById('settings-form');
  if (settingsForm) {
    const settingsFields = settingsForm.querySelector('#settings-fields');
    const integrationKeys = {
      wordnik: 'INTEGRATION_WORDNIK',
      immich: 'INTEGRATION_IMMICH',
      jellyfin: 'INTEGRATION_JELLYFIN',
      fact: 'INTEGRATION_FACT',
    };
    const envSettingKeys = [
      'JOURNALS_DIR',
      'DATA_DIR',
      'APP_DIR',
      'PROMPTS_FILE',
      'STATIC_DIR',
      'TEMPLATES_DIR',
      'WORDNIK_API_KEY',
      'OPENAI_API_KEY',
      'IMMICH_URL',
      'IMMICH_API_KEY',
      'IMMICH_TIME_BUFFER',
      'JELLYFIN_URL',
      'JELLYFIN_API_KEY',
      'JELLYFIN_USER_ID',
      'JELLYFIN_PAGE_SIZE',
      'JELLYFIN_PLAY_THRESHOLD',
      'NOMINATIM_USER_AGENT',
      'LOG_LEVEL',
      'LOG_FILE',
      'LOG_MAX_BYTES',
      'LOG_BACKUP_COUNT',
      'BASIC_AUTH_USERNAME',
      'BASIC_AUTH_PASSWORD',
    ];

    fetch('/api/settings')
      .then((r) => r.json())
      .then((settings) => {
        envSettingKeys.forEach((key) => {
          if (!(key in settings)) {
            settings[key] = '';
          }
        });

        Object.entries(integrationKeys).forEach(([key, settingKey]) => {
          const cb = document.getElementById(`integration-${key}`);
          if (cb) {
            cb.checked = settings[settingKey] !== 'false';
            delete settings[settingKey];
          }
        });

        Object.entries(settings).forEach(([key, value]) => {
          const label = document.createElement('label');
          label.className = 'flex items-center gap-2 justify-between';
          label.textContent = key;
          const input = document.createElement('input');
          input.type = 'text';
          input.id = `setting-${key}`;
          input.value = value;
          input.className = 'flex-1 border border-gray-300 dark:border-gray-600 rounded px-2 py-1 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-100 focus:outline-none focus:ring focus:ring-blue-500 dark:focus:ring-blue-400';
          label.appendChild(input);
          settingsFields.appendChild(label);
        });
      });

    settingsForm.querySelector('#save-settings').addEventListener('click', async () => {
      const updated = {};
      settingsFields.querySelectorAll('input').forEach((input) => {
        const k = input.id.replace('setting-', '');
        updated[k] = input.value;
      });

      Object.entries(integrationKeys).forEach(([key, settingKey]) => {
        const cb = document.getElementById(`integration-${key}`);
        updated[settingKey] = cb && cb.checked ? 'true' : 'false';
      });

      await fetch('/api/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updated),
      });
    });
  }
});
</script>

{% endblock %}
