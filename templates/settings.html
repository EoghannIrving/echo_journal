{% extends "base.html" %}

{% block title %}Settings - Echo Journal{% endblock %}

{% block main_classes %}w-full max-w-md md:max-w-2xl lg:max-w-5xl xl:max-w-6xl mx-auto space-y-6 bg-gray-100 dark:bg-[#222] text-gray-800 dark:text-gray-100{% endblock %}

{% block header_title %}
  <h1 id="welcome-message" class="font-serif font-bold text-[clamp(1.75rem,2vw+1rem,2.5rem)] text-center mb-2 opacity-0">Settings</h1>
{% endblock %}

{% block content %}

<section class="w-full max-w-5xl mx-auto space-y-4 bg-gray-100 dark:bg-[#222] text-gray-800 dark:text-gray-100 p-4 rounded-xl paper-card">
  <form id="settings-form" class="w-full text-sm space-y-4">
    <p class="text-center text-gray-500 dark:text-gray-400">Enable or disable optional integrations and edit server settings. Values are saved to <code>settings.yaml</code>. Changes require a restart.</p>
    <fieldset id="integration-settings" class="space-y-2 text-left">
      <legend class="font-semibold text-lg">Integrations</legend>
      <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
        <div class="p-4 rounded-xl paper-card flex items-center justify-between gap-4">
          <label for="integration-wordnik" class="flex items-center gap-2 cursor-pointer">
            <span class="text-2xl">üìñ</span>
            <span id="integration-wordnik-label" class="text-sm">Wordnik word of the day</span>
          </label>
          <input
            type="checkbox"
            id="integration-wordnik"
            aria-labelledby="integration-wordnik-label"
            class="h-5 w-5"
          />
        </div>
        <div class="p-4 rounded-xl paper-card flex items-center justify-between gap-4">
          <label for="integration-immich" class="flex items-center gap-2 cursor-pointer">
            <span class="text-2xl">üì∏</span>
            <span id="integration-immich-label" class="text-sm">Immich photos</span>
          </label>
          <input
            type="checkbox"
            id="integration-immich"
            aria-labelledby="integration-immich-label"
            class="h-5 w-5"
          />
        </div>
        <div class="p-4 rounded-xl paper-card flex items-center justify-between gap-4">
          <label for="integration-jellyfin" class="flex items-center gap-2 cursor-pointer">
            <span class="text-2xl">üé¨</span>
            <span id="integration-jellyfin-label" class="text-sm">Jellyfin media</span>
          </label>
          <input
            type="checkbox"
            id="integration-jellyfin"
            aria-labelledby="integration-jellyfin-label"
            class="h-5 w-5"
          />
        </div>
        <div class="p-4 rounded-xl paper-card flex items-center justify-between gap-4">
          <label for="integration-fact" class="flex items-center gap-2 cursor-pointer">
            <span class="text-2xl">‚ùì</span>
            <span id="integration-fact-label" class="text-sm">Fact of the day</span>
          </label>
          <input
            type="checkbox"
            id="integration-fact"
            aria-labelledby="integration-fact-label"
            class="h-5 w-5"
          />
        </div>
      </div>
    </fieldset>
      <div id="settings-fields" class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4"></div>
    <button type="button" id="save-settings" class="mx-auto block bg-blue-600 hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 text-white px-4 py-2 rounded font-semibold transition focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400">Save</button>
    <div id="settings-message" class="fixed top-4 right-4 z-50 hidden" aria-live="polite" role="status"></div>
  </form>
</section>

<footer class="w-full max-w-5xl mt-8 bg-gray-100 dark:bg-[#222] text-[clamp(0.9rem,0.8vw+0.8rem,1rem)] text-gray-500 dark:text-gray-400 text-center leading-snug tracking-wide">
  <img src="/static/icons/echo_journal_transparent_128x128.png" alt="Echo Journal logo" class="h-16 inline align-middle opacity-50 transition">
  Echo Journal
</footer>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const animateText = (target, startDelay = 0, letterDelay = 80, wordDelay = 150) => {
    if (!target) return 0;
    const text = target.textContent.trim();
    target.textContent = "";

    let delay = startDelay;
    const tokens = text.split(/(\s+)/);

    tokens.forEach((token) => {
      if (/^\s+$/.test(token)) {
        target.appendChild(document.createTextNode(token));
        return;
      }

      const wordSpan = document.createElement('span');
      wordSpan.style.whiteSpace = 'nowrap';
      wordSpan.style.display = 'inline-block';

      Array.from(token).forEach((ch) => {
        const letter = document.createElement('span');
        letter.textContent = ch;
        letter.className = 'letter-span inline-block opacity-0 transition-opacity duration-200';
        letter.style.transitionDelay = `${delay}ms`;
        delay += letterDelay;
        wordSpan.appendChild(letter);
      });

      delay += wordDelay;
      target.appendChild(wordSpan);
    });

    target.classList.remove('opacity-0');
    requestAnimationFrame(() => {
      target.querySelectorAll('.letter-span').forEach((span) => span.classList.add('opacity-100'));
    });

    return delay;
  };

  const welcomeEl = document.getElementById("welcome-message");
  const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  if (welcomeEl) {
    if (prefersReducedMotion) {
      welcomeEl.classList.remove('opacity-0');
    } else {
      animateText(welcomeEl, 0, 60, 200);
    }
  }

    const settingsForm = document.getElementById('settings-form');
    if (settingsForm) {
      const settingsFields = settingsForm.querySelector('#settings-fields');
      const integrationKeys = {
        wordnik: 'INTEGRATION_WORDNIK',
        immich: 'INTEGRATION_IMMICH',
        jellyfin: 'INTEGRATION_JELLYFIN',
        fact: 'INTEGRATION_FACT',
      };
    const envSettingCategories = {
      Paths: [
        'DATA_DIR',
        'APP_DIR',
        'PROMPTS_FILE',
        'STATIC_DIR',
        'TEMPLATES_DIR',
      ],
      'API Keys': [
        'WORDNIK_API_KEY',
        'OPENAI_API_KEY',
        'IMMICH_API_KEY',
        'JELLYFIN_API_KEY',
      ],
      Immich: ['IMMICH_URL', 'IMMICH_TIME_BUFFER'],
      Jellyfin: [
        'JELLYFIN_URL',
        'JELLYFIN_USER_ID',
        'JELLYFIN_PAGE_SIZE',
        'JELLYFIN_PLAY_THRESHOLD',
      ],
      Logging: ['LOG_LEVEL', 'LOG_FILE', 'LOG_MAX_BYTES', 'LOG_BACKUP_COUNT'],
      Authentication: ['BASIC_AUTH_USERNAME', 'BASIC_AUTH_PASSWORD'],
      Other: ['NOMINATIM_USER_AGENT'],
    };

    let messageTimeout;
    const showMessage = (text, type = 'info') => {
      const messageEl = document.getElementById('settings-message');
      if (!messageEl) return;
      const base = 'flex items-center gap-2 p-4 rounded-md shadow-md border transition-opacity duration-300';
      const colors = {
        info: 'bg-blue-100 border-blue-200 text-blue-800',
        success: 'bg-green-100 border-green-200 text-green-800',
        error: 'bg-red-100 border-red-200 text-red-800',
      };
      messageEl.innerHTML = `
        <div class="${base} ${colors[type]} opacity-0">
          <span>${text}</span>
          <button type="button" aria-label="Dismiss" class="ml-2 text-lg leading-none">&times;</button>
        </div>
      `;
      messageEl.classList.remove('hidden');
      requestAnimationFrame(() => {
        const alert = messageEl.querySelector('div');
        if (alert) alert.classList.remove('opacity-0');
      });
      const hide = () => {
        const alert = messageEl.querySelector('div');
        if (alert) {
          alert.classList.add('opacity-0');
          setTimeout(() => {
            messageEl.classList.add('hidden');
            messageEl.innerHTML = '';
          }, 300);
        }
      };
      const btn = messageEl.querySelector('button');
      if (btn) btn.addEventListener('click', hide);
      clearTimeout(messageTimeout);
      messageTimeout = setTimeout(hide, 4000);
    };

    const envKeyInfo = {
      DATA_DIR: {
        label: 'Data directory',
        help: 'Location for persistent data files',
        placeholder: '/path/to/data',
      },
      APP_DIR: {
        label: 'Application directory',
        help: 'Root path of the Echo Journal installation',
        placeholder: '/path/to/app',
      },
      PROMPTS_FILE: {
        label: 'Prompts file',
        help: 'YAML file containing writing prompts',
        placeholder: '/path/to/prompts.yaml',
      },
      STATIC_DIR: {
        label: 'Static directory',
        help: 'Directory for static assets like images and CSS',
        placeholder: '/path/to/static',
      },
      TEMPLATES_DIR: {
        label: 'Templates directory',
        help: 'Directory containing HTML templates',
        placeholder: '/path/to/templates',
      },
      WORDNIK_API_KEY: {
        label: 'Wordnik API key',
        help: 'Required for word of the day integration',
        placeholder: 'your-wordnik-key',
      },
      OPENAI_API_KEY: {
        label: 'OpenAI API key',
        help: 'Used for AI prompt features',
        placeholder: 'sk-XXXXXXXXXXXXXXXXXXXX',
      },
      IMMICH_API_KEY: {
        label: 'Immich API key',
        help: 'Token for Immich API access',
        placeholder: 'your-immich-api-key',
      },
      JELLYFIN_API_KEY: {
        label: 'Jellyfin API key',
        help: 'Token for Jellyfin API access',
        placeholder: 'your-jellyfin-api-key',
      },
      IMMICH_URL: {
        label: 'Immich URL',
        help: 'Base URL of your Immich instance',
        placeholder: 'https://immich.example.com',
      },
      IMMICH_TIME_BUFFER: {
        label: 'Immich time buffer',
        help: 'How far back to fetch photos in minutes',
        placeholder: '60',
      },
      JELLYFIN_URL: {
        label: 'Jellyfin URL',
        help: 'Base URL of your Jellyfin server',
        placeholder: 'https://jellyfin.example.com',
      },
      JELLYFIN_USER_ID: {
        label: 'Jellyfin user ID',
        help: 'Identifier of your Jellyfin user account',
        placeholder: 'your-user-id',
      },
      JELLYFIN_PAGE_SIZE: {
        label: 'Jellyfin page size',
        help: 'Number of items to fetch per request',
        placeholder: '100',
      },
      JELLYFIN_PLAY_THRESHOLD: {
        label: 'Jellyfin play threshold',
        help: 'Minimum play count required for inclusion',
        placeholder: '5',
      },
      LOG_LEVEL: {
        label: 'Log level',
        help: 'Logging verbosity (e.g., INFO, DEBUG)',
        placeholder: 'INFO',
      },
      LOG_FILE: {
        label: 'Log file',
        help: 'File path for application logs',
        placeholder: '/var/log/echo_journal.log',
      },
      LOG_MAX_BYTES: {
        label: 'Log max bytes',
        help: 'Maximum size of the log file before rotation',
        placeholder: '1048576',
      },
      LOG_BACKUP_COUNT: {
        label: 'Log backup count',
        help: 'Number of rotated log files to keep',
        placeholder: '3',
      },
      BASIC_AUTH_USERNAME: {
        label: 'Basic auth username',
        help: 'Username for HTTP basic authentication',
        placeholder: 'username',
      },
      BASIC_AUTH_PASSWORD: {
        label: 'Basic auth password',
        help: 'Password for HTTP basic authentication',
        placeholder: 'password',
      },
      NOMINATIM_USER_AGENT: {
        label: 'Nominatim user agent',
        help: 'User agent string for Nominatim requests',
        placeholder: 'my-app/1.0',
      },
    };
    const loading = document.createElement('div');
    loading.id = 'settings-loading';
    loading.className = 'w-full flex justify-center py-8';
    loading.innerHTML = '<div class="h-8 w-8 border-4 border-blue-600 dark:border-blue-500 border-t-transparent rounded-full animate-spin"></div>';
    settingsFields.appendChild(loading);

    fetch('/api/settings')
      .then((r) => r.json())
      .then((settings) => {
        Object.values(envSettingCategories)
          .flat()
          .forEach((key) => {
            if (!(key in settings)) {
              settings[key] = '';
            }
          });

        Object.entries(integrationKeys).forEach(([key, settingKey]) => {
          const cb = document.getElementById(`integration-${key}`);
          if (cb) {
            cb.checked = String(settings[settingKey]).toLowerCase() !== 'false';
            delete settings[settingKey];
          }
        });

        const categorized = {};
        // Ensure all categories are initialised
        Object.keys(envSettingCategories).forEach((cat) => {
          categorized[cat] = [];
        });
        Object.keys(settings).forEach((key) => {
          let category = 'Miscellaneous';
          for (const [cat, keys] of Object.entries(envSettingCategories)) {
            if (keys.includes(key)) {
              category = cat;
              break;
            }
          }
          if (!categorized[category]) {
            categorized[category] = [];
          }
          categorized[category].push(key);
        });

        const categoryOrder = [...Object.keys(envSettingCategories), 'Miscellaneous'];
        categoryOrder.forEach((category) => {
          const keys = categorized[category];
          if (!keys || keys.length === 0) return;
          const details = document.createElement('details');
          details.className = 'paper-card space-y-2 text-left w-full';
          details.open = true;
          const summary = document.createElement('summary');
          summary.textContent = category;
          summary.className = 'cursor-pointer font-semibold';
          details.appendChild(summary);
          const grid = document.createElement('div');
          grid.className = 'grid gap-2 sm:grid-cols-2 lg:grid-cols-1 w-full';
          keys.forEach((key) => {
            const info = envKeyInfo[key] || {};
            const labelText = info.label || key;
            const wrapper = document.createElement('div');
            wrapper.className = 'space-y-1 w-full';
            const label = document.createElement('label');
            label.className = 'flex flex-col md:flex-row md:items-center md:justify-between gap-2';
            const span = document.createElement('span');
            span.textContent = labelText;
            label.appendChild(span);
            const input = document.createElement('input');
            input.type = 'text';
            input.id = `setting-${key}`;
            input.value = settings[key];
            if (info.placeholder) {
              input.placeholder = info.placeholder;
            }
            input.className = 'w-full border border-gray-300 dark:border-gray-600 rounded px-2 py-1 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring focus:ring-blue-500 dark:focus:ring-blue-400';
            label.appendChild(input);
            wrapper.appendChild(label);
            if (info.help) {
              const help = document.createElement('p');
              const helpId = `setting-${key}-help`;
              help.id = helpId;
              help.className = 'text-xs text-gray-500 dark:text-gray-400';
              help.textContent = info.help;
              input.setAttribute('aria-describedby', helpId);
              wrapper.appendChild(help);
            }
            grid.appendChild(wrapper);
          });
          details.appendChild(grid);
          settingsFields.appendChild(details);
        });
      })
      .finally(() => loading.remove());

    settingsForm.querySelector('#save-settings').addEventListener('click', async () => {
      showMessage('Saving‚Ä¶', 'info');
      const updated = {};
      settingsFields.querySelectorAll('input').forEach((input) => {
        const k = input.id.replace('setting-', '');
        updated[k] = input.value;
      });

      Object.entries(integrationKeys).forEach(([key, settingKey]) => {
        const cb = document.getElementById(`integration-${key}`);
        updated[settingKey] = cb && cb.checked ? 'true' : 'false';
      });

      try {
        const resp = await fetch('/api/settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updated),
        });
        if (!resp.ok) {
          throw new Error('Request failed');
        }
        showMessage('Settings saved', 'success');
      } catch (err) {
        showMessage('Error saving settings', 'error');
      }
    });
  }
});
</script>

{% endblock %}
