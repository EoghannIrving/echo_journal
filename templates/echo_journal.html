{% extends "base.html" %}

{% block title %}Echo Journal{% endblock %}

{% block header_title %}
  <h1 id="welcome-message" class="font-serif font-bold text-[clamp(1.75rem,2vw+1rem,2.5rem)] text-center mb-2 opacity-0 transition-opacity duration-[2000ms] delay-300"
      {% if not readonly %} data-dynamic-greeting="true"{% endif %}>
    {% if readonly %}
      Welcome back to {{ date }}
    {% else %}
      Welcome back.
    {% endif %}
  </h1>
{% endblock %}

{% block content %}
<section class="w-full mx-auto space-y-2 text-center">
  <div class="p-4 border-b border-gray-600 mb-6">
    <p class="font-sans font-medium text-[clamp(1.5rem,2vw+1rem,2rem)] leading-snug mb-2">{{ prompt }}</p>
    <p class="text-[clamp(0.9rem,0.8vw+0.8rem,1rem)] text-gray-500 dark:text-gray-400 text-center leading-snug tracking-wide">Echo Journal is <strong>your</strong> space. Let the words come naturally.</p>
  </div>
</section>
<section class="w-full mx-auto editor-container">
  {% if not readonly %}
  <div id="md-toolbar" class="flex space-x-2 justify-center markdown-toolbar" aria-label="Formatting toolbar">
    <button type="button" class="md-btn text-base md:text-2xl" data-action="bold" title="Bold"><strong>B</strong></button>
    <button type="button" class="md-btn text-base md:text-2xl" data-action="italic" title="Italic"><em>I</em></button>
    <button type="button" class="md-btn text-base md:text-2xl" data-action="header" title="Heading">H1</button>
    <button type="button" class="md-btn text-base md:text-2xl" data-action="list" title="List">&#8226;</button>
  </div>
  <label for="journal-text" class="sr-only">Journal entry</label>
  <textarea id="journal-text" class="journal-textarea"
    placeholder="Write freely… describe what happened, how you felt, what you noticed, or anything else that stands out."
    oninput="this.style.height='auto'; this.style.height=(this.scrollHeight)+'px'"
    rows="4"
  >{{ content }}</textarea>
  {% else %}
    <div class="journal-html w-[90%] max-w-[90%] mx-auto p-6 font-serif bg-gray-100 dark:bg-slate-700 rounded-xl shadow prose dark:prose-invert prose-lg">
    {{ content_html|safe }}</div>
  {% endif %}
</section>
    {% if not readonly %}
  <section class="w-full mx-auto mt-6">
    <button id="save-button" class="block w-[65%] max-w-[15rem] mx-auto mt-3 bg-slate-500 text-white rounded-xl py-3 text-lg font-semibold shadow transition hover:bg-slate-600 hover:brightness-105 hover:shadow-lg dark:bg-gray-400 dark:hover:bg-slate-500" aria-label="Save entry">Save Entry</button>
  </section>
    {% endif %}

  <footer class="w-full mx-auto mt-8 text-[clamp(0.9rem,0.8vw+0.8rem,1rem)] text-gray-500 dark:text-gray-400 text-center leading-snug tracking-wide" id="save-status" aria-live="polite" role="status">
  <img src="/static/icons/echo_journal_transparent_128x128.png" alt="Echo Journal logo" class="h-16 inline align-middle opacity-50 transition">
  {% if content %}Last saved: loaded from file{% else %}Last saved: no entry yet{% endif %} — Echo Journal
  </footer>

  <script>

document.addEventListener("DOMContentLoaded", () => {

  const el = document.getElementById("welcome-message");
  if (el) {

    const wantsGreeting = el.dataset.dynamicGreeting === "true";

    if (wantsGreeting) {
      const hour = new Date().getHours();
      let greeting = "";

      if (hour < 12) greeting = "☀️ Good morning.";
      else if (hour < 18) greeting = "🌿 Good afternoon.";
      else greeting = "🌙 Good evening.";

      el.textContent = greeting;
    }

    requestAnimationFrame(() => {
      el.style.opacity = 1;
    });
  }

  const toolbar = document.getElementById('md-toolbar');
  const textarea = document.getElementById('journal-text');
  if (toolbar && textarea) {
    toolbar.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-action]');
      if (!btn) return;
      const action = btn.dataset.action;
      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;
      const text = textarea.value;

      const wrap = (token) => {
        const selected = text.slice(start, end);
        const result = text.slice(0, start) + token + selected + token + text.slice(end);
        textarea.value = result;
        textarea.selectionStart = start + token.length;
        textarea.selectionEnd = end + token.length;
      };

      const prefixLines = (prefix) => {
        const before = text.slice(0, start);
        const selection = text.slice(start, end);
        const after = text.slice(end);
        const lines = selection.split(/\n/);
        const formatted = lines.map(line => prefix + line).join('\n');
        textarea.value = before + formatted + after;
        textarea.selectionStart = start;
        textarea.selectionEnd = start + formatted.length;
      };

      if (action === 'bold') wrap('**');
      else if (action === 'italic') wrap('_');
      else if (action === 'header') prefixLines('# ');
      else if (action === 'list') prefixLines('- ');

      textarea.focus();
    });
  }
});


const saveButton = document.getElementById('save-button');
if (saveButton) {
  saveButton.addEventListener('click', async () => {
    const content = document.getElementById('journal-text').value;
    const date = "{{ date }}";
    const prompt = {{ prompt | tojson }};

    const response = await fetch("/entry", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ date, content, prompt })
    });

    const result = await response.json();
    const status = document.getElementById('save-status');
    if (result.status === "success") {
      status.textContent = "Last saved: just now — Echo Journal";
      status.classList.remove('error-text');
    } else {
      status.textContent = "Save failed. Please try again.";
      status.classList.add('error-text');
    }
  });
}

document.addEventListener('keydown', (e) => {
  if ((e.ctrlKey || e.metaKey) && e.key === 's') {
    e.preventDefault();
    if (saveButton) {
      saveButton.click();
    }
  }
});

  </script>
{% endblock %}
